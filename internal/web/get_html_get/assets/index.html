<!doctype html>
<html lang="ru">
<script>
    const TurnX= 10
    const TurnO = 11
    const NoneWinner = 20
    const Drow       = 21
    const WinnerX    = 22
    const WinnerO    = 23
    const PointValueEmpty = 0
    const PointValueO     = 1
    const PointValueX     = 2
</script>
<head>
    <meta charset="utf-8" />
    <title>Tic-Tac-Toe (Go backend)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        :root {
            --gap: 12px;
            --size: 96px;
            --radius: 14px;
            --bg: #0f172a;
            --card: #111827;
            --grid: #1f2937;
            --txt: #e5e7eb;
            --muted: #94a3b8;
            --accent: #22c55e;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            background: var(--bg);
            color: var(--txt);
            font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        }

        .wrap {
            max-width: 640px;
            margin: 40px auto;
            padding: 20px;
        }

        .row {
            display: flex;
            gap: var(--gap);
            align-items: center;
            justify-content: space-between;
        }

        .card {
            background: var(--card);
            border-radius: 16px;
            padding: 18px 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
        }

        h1 {
            margin: 0 0 12px;
            font-size: 22px
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, var(--size));
            gap: 10px;
            justify-content: center;
            margin: 16px 0 8px;
        }

        .cell {
            width: var(--size);
            height: var(--size);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 44px;
            background: var(--grid);
            cursor: pointer;
            user-select: none;
            transition: transform .05s ease;
        }

        .cell:active {
            transform: scale(.98)
        }

        .cell.disabled {
            opacity: .5;
            pointer-events: none;
            cursor: not-allowed
        }

        .bar {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-top: 8px;
            flex-wrap: wrap
        }

        button {
            background: #2563eb;
            color: white;
            border: 0;
            padding: 10px 14px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer
        }

        button.secondary {
            background: #374151
        }

        .status {
            margin: 6px 0 0;
            color: var(--muted)
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #334155;
            color: #e2e8f0;
            font-size: 12px;
            margin-left: 6px
        }

        .ok {
            background: #14532d
        }

        .err {
            background: #7f1d1d
        }

        .legend {
            font-size: 13px;
            color: #94a3b8;
            margin-top: 10px;
            text-align: center
        }

        a {
            color: #60a5fa;
            text-decoration: none
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <h1>–ö—Ä–µ—Å—Ç–∏–∫–∏-–Ω–æ–ª–∏–∫–∏ <span id="gameId" class="badge"></span></h1>
            <div id="status" class="status">–ù–∞–∂–º–∏—Ç–µ ¬´–ù–æ–≤–∞—è –∏–≥—Ä–∞¬ª</div>
            <div id="grid" class="grid"></div>
            <div class="bar">
                <button id="newGame">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
                <button id="reset" class="secondary">–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
            </div>
            <div id="legend" class="legend"></div>
        </div>
    </div>

    <script>
        (async () => {
            const API_BASE = ''; // –µ—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç —Å —Ç–æ–≥–æ –∂–µ –ø–æ—Ä—Ç–∞. –ò–Ω–∞—á–µ 'http://localhost:8080'
            const gridEl   = document.getElementById('grid');
            const statusEl = document.getElementById('status');
            const idEl     = document.getElementById('gameId');
            const newBtn   = document.getElementById('newGame');
            const resetBtn = document.getElementById('reset');

            let gameId = null;
            let matrix = [[0,0,0],[0,0,0],[0,0,0]];
            let winner = NoneWinner, turn = PointValueX, busy = false;

            // –ï—Å–ª–∏ —É–∂–µ –Ω–∞ /game/<id>, –≤—ã—Ç–∞—â–∏–º id –∏–∑ URL (F5/–ø—Ä—è–º–æ–π –≤—Ö–æ–¥)
            const parts = location.pathname.split('/').filter(Boolean);
            if (parts[0] === 'game' && parts[1]) {
                gameId = parts[1];
            }

            function draw() {
                gridEl.innerHTML = '';
                for (let i = 0; i < 3; i++) {
                    for (let j = 0; j < 3; j++) {
                        const v = matrix[i][j];
                        const cell = document.createElement('div');
                        cell.className = 'cell' + (busy || winner !== NoneWinner ? ' disabled' : '');
                        cell.dataset.i = i; cell.dataset.j = j;
                        cell.textContent = v === PointValueO ? 'O' : (v === PointValueX ? 'X' : '');
                        cell.onclick = () => onCellClick(i, j);
                        gridEl.appendChild(cell);
                    }
                }
                idEl.textContent = gameId ? `id: ${gameId}` : '';
                if (!gameId) {
                    setStatus('–ù–∞–∂–º–∏—Ç–µ ¬´–ù–æ–≤–∞—è –∏–≥—Ä–∞¬ª');
                } else if (winner !== NoneWinner) {
                    if (winner === WinnerX) setStatus('–ü–æ–±–µ–¥–∏–ª X üèÜ', 'ok');
                    else if (winner === WinnerO) setStatus('–ü–æ–±–µ–¥–∏–ª O üèÜ', 'ok');
                    else if (winner === Drow) setStatus('–ù–∏—á—å—è ü§ù', 'ok');
                    else setStatus('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'ok');
                } else {
                    setStatus(`–í–∞—à —Ö–æ–¥: X ${busy ? '(–æ–∂–∏–¥–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞...)' : ''}`);
                }
            }

            const legendEl = document.getElementById('legend');
            if (legendEl) {
                legendEl.textContent = `X = ${PointValueX}, O = ${PointValueO}, –ø—É—Å—Ç–æ = ${PointValueEmpty} ‚Ä¢ –•–æ–¥ –∏–≥—Ä–æ–∫–∞: X ‚Ä¢ –°–µ—Ä–≤–µ—Ä —Ö–æ–¥–∏—Ç O`;
            }

            function setStatus(msg, kind) {
                statusEl.textContent = msg;
                statusEl.className = 'status';
                if (kind === 'ok') statusEl.classList.add('ok', 'badge');
                if (kind === 'err') statusEl.classList.add('err', 'badge');
            }

            async function createGame() {
                try {
                    busy = true; draw();
                    const res = await fetch(API_BASE + '/game', { method: 'GET' });
                    if (!res.ok) throw new Error('create failed: ' + res.status);
                    const data = await res.json(); // { id: "..." }
                    gameId = data.id;

                    // –û–±–Ω–æ–≤–∏–º –∞–¥—Ä–µ—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É –Ω–∞ /game/<id> –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                    if (history.pushState) {
                        history.pushState(null, '', '/game/' + encodeURIComponent(gameId));
                    } else {
                        location.hash = '#'+gameId; // fallback
                    }

                    // –°–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    matrix = [[PointValueEmpty,PointValueEmpty,PointValueEmpty],[PointValueEmpty,PointValueEmpty,PointValueEmpty],[PointValueEmpty,PointValueEmpty,PointValueEmpty]];
                    winner = NoneWinner; turn = PointValueX;
                    setStatus('–ò–≥—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞. –í–∞—à —Ö–æ–¥: X');
                } catch (e) {
                    console.error(e);
                    setStatus('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É', 'err');
                } finally {
                    busy = false; draw();
                }
            }

            // –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–±—Ä–æ—Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è (–±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞). –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.
            function resetLocal() {
                matrix = [[PointValueEmpty, PointValueEmpty, PointValueEmpty], [PointValueEmpty, PointValueEmpty, PointValueEmpty], [PointValueEmpty, PointValueEmpty, PointValueEmpty]];
                winner = NoneWinner;
                draw();
            }

            async function onCellClick(i, j) {
                if (busy || !gameId || winner !== NoneWinner) return;
                if (matrix[i][j] !== PointValueEmpty) return;
                if (turn !== PointValueX) { setStatus('–°–µ–π—á–∞—Å –Ω–µ –≤–∞—à —Ö–æ–¥', 'err'); return; }

                // —Å—Ç–∞–≤–∏–º X –ª–æ–∫–∞–ª—å–Ω–æ
                matrix = matrix.map(row => row.slice());
                matrix[i][j] = PointValueX;
                busy = true; draw();

                try {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—è
                    const res = await fetch(API_BASE + '/game/' + encodeURIComponent(gameId), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ board: matrix })
                    });

                    if (!res.ok) {
                        const err = await safeJson(res);
                        const msg = err?.error || ('server error ' + res.status);
                        setStatus(msg, 'err');
                        // –æ—Ç–∫–∞—Ç –∫–ª–µ—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                        matrix[i][j] = PointValueEmpty;
                        return;
                    }

                    const data = await res.json();
                    // –æ–∂–∏–¥–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—É—é –∏–≥—Ä—É —Å —É–∂–µ —Å–¥–µ–ª–∞–Ω–Ω—ã–º —Ö–æ–¥–æ–º O
                    matrix = data.board ?? matrix;
                    winner = data.winner ?? NoneWinner;

                    if (winner) {
                        if (winner === WinnerX) setStatus('–ü–æ–±–µ–¥–∏–ª X üèÜ', 'ok');
                        else if (winner === WinnerO) setStatus('–ü–æ–±–µ–¥–∏–ª O üèÜ', 'ok');
                        else if (winner === Drow) setStatus('–ù–∏—á—å—è ü§ù', 'ok');
                        else setStatus('–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'ok');
                    } else {
                        setStatus('–í–∞—à —Ö–æ–¥: X');
                    }
                } catch (e) {
                    console.error(e);
                    setStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'err');
                    // –æ—Ç–∫–∞—Ç –∫–ª–µ—Ç–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                    matrix[i][j] = PointValueEmpty;
                } finally {
                    busy = false; draw();
                }
            }

            async function safeJson(res) {
                try { return await res.json(); } catch { return null; }
            }

            // UI —Å–æ–±—ã—Ç–∏—è
            newBtn.addEventListener('click', createGame);
            resetBtn.addEventListener('click', resetLocal);

            // –Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞
            draw();
        })();
    </script>
</body>

</html>